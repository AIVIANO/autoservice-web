const { AppError } = require("../errors/appError");const { parseIsoDate } = require("../utils/validators");const bookingsRepo = require("../repositories/bookings.repo");const clientsRepo = require("../repositories/clients.repo");const carsRepo = require("../repositories/cars.repo");const BOOKING_STATUSES = ["new", "confirmed", "cancelled", "completed"];async function createBooking(req, res, next) {  try {    const { client_id, car_id, service_id, scheduled_at, service_note } = req.body;    const cid = Number(client_id);    const carid = Number(car_id);    if (!Number.isInteger(cid) || cid <= 0 || !Number.isInteger(carid) || carid <= 0) {      throw new AppError(400, "Validation error", { required: ["client_id", "car_id"] });    }    const dt = parseIsoDate(scheduled_at);    if (!dt) throw new AppError(400, "Validation error", { field: "scheduled_at", format: "ISO-8601" });    const client = await clientsRepo.getClientById(cid);    if (!client) throw new AppError(404, "Client not found");    const car = await carsRepo.getCarById(carid);    if (!car) throw new AppError(404, "Car not found");    if (Number(car.client_id) !== cid) throw new AppError(409, "Car does not belong to client");    const sid = service_id === undefined || service_id === null ? null : Number(service_id);    if (sid !== null && (!Number.isInteger(sid) || sid <= 0)) {      throw new AppError(400, "Validation error", { field: "service_id" });    }    const created = await bookingsRepo.createBooking({      client_id: cid,      car_id: carid,      service_id: sid,      scheduled_at,      service_note    });    return res.status(201).json(created);  } catch (e) {    return next(e);  }}async function listBookings(req, res, next) {  try {    const rows = await bookingsRepo.listBookings();    return res.json(rows);  } catch (e) {    return next(e);  }}async function getBooking(req, res, next) {  try {    const id = Number(req.params.id);    if (!Number.isInteger(id) || id <= 0) throw new AppError(400, "Invalid id");    const row = await bookingsRepo.getBookingById(id);    if (!row) throw new AppError(404, "Booking not found");    return res.json(row);  } catch (e) {    return next(e);  }}async function patchBookingStatus(req, res, next) {  try {    const id = Number(req.params.id);    if (!Number.isInteger(id) || id <= 0) throw new AppError(400, "Invalid id");    const { status } = req.body;    if (typeof status !== "string" || !BOOKING_STATUSES.includes(status)) {      throw new AppError(400, "Validation error", { allowed: BOOKING_STATUSES });    }    const updated = await bookingsRepo.updateBookingStatus(id, status);    if (!updated) throw new AppError(404, "Booking not found");    return res.json(updated);  } catch (e) {    return next(e);  }}module.exports = { createBooking, listBookings, getBooking, patchBookingStatus };